<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Auth</title>
    
    <script src="https://apps.bdimg.com/libs/jquery/2.1.4/jquery.min.js"></script>
    <script>
        login = '';
        need = false;
        submiting = false;

        function refresh() {
            updateStatus(function(){
                if (need) {
                    $('img').attr("src", "/auth/captcha?" + (new Date()).getTime());
                    $('#num').val('');
                }
            });
        }
        function enter(event) {
            if (!login) {
                if (event.keyCode == 13) {
                    submitRegister();
                }
            }
        }
        function hide(el) {
            $(el).addClass('hide');
        }
        function show(el) {
            $(el).removeClass('hide');
        }
        function updateStatus(callback) {
            $.get('/auth/status', function (result) {
                login = result.login;
                need = result.needCaptcha;
                if (need) {
                    show('#captcha');
                } else {
                    hide('#captcha');
                }
                if (login) {
                    hide('#reg-form');
                    show('#content');
                    $('#name').text(login);
                } else {
                    hide('#content');
                    show('#reg-form');
                }
                callback();
            }).fail(function(){
                callback();
            });
        }
        function startSubmit() {
            $('#reg').attr('disabled', true);
            $('#num').attr('disabled', true);
            $('#un').attr('disabled', true);
            $('#pw').attr('disabled', true);
            submiting = true;
        }
        function endSubmit() {
            refresh();
            $('#reg').attr('disabled', false);
            $('#num').attr('disabled', false);
            $('#un').attr('disabled', false);
            $('#pw').attr('disabled', false);
            $('#pw').val('');
            $('#num').val('');
            submiting = false;
        }
        
        function checkCaptcha(number, callback) {
            if (need) {
                $.post('/auth/captcha', {
                    captcha: number
                }, function (result) {
                    if (result.fail) {
                        $('#numx').text('X 错误的验证码');
                        show('#numx');
                    }
                    callback(!result.fail);
                }).error(function(){
                    callback();
                });
            } else {
                callback(true)
            }
        }

        function submitRegister() {
            startSubmit();
            var cpc = $('#num').val();
            var un = $('#un').val();
            var pw = $('#pw').val();
            checkCaptcha(cpc, function (pass) {
                if (!pass) {
                    endSubmit();
                } else {
                    $.post('/auth/register', {
                        username: un,
                        password: pw
                    }, function (result) {
                        hide('#reg-form span');
                        if (result.success || result.fail['user-exists']) {
                            $.post('/auth/login', {
                                username: un,
                                password: pw
                            }, function (result) {
                                if (!result.success) {
                                    var unerr = result.fail['bad-username'] || result.fail['no-user'];
                                    if (unerr) {
                                        $('#unx').text('X ' + unerr);
                                        show('#unx');
                                    }
                                    var pwerr = result.fail['bad-password'] || result.fail['wrong-password'];
                                    if (pwerr) {
                                        $('#pwx').text('X ' + pwerr);
                                        show('#pwx');
                                    }
                                }
                                endSubmit();
                            }).error(function () {
                                endSubmit();
                            });
                        } else {
                            var unerr = result.fail['bad-username'];
                            if (unerr) {
                                $('#unx').text('X ' + unerr);
                                show('#unx');
                            }
                            var pwerr = result.fail['bad-password'];
                            if (pwerr) {
                                $('#pwx').text('X ' + pwerr);
                                show('#pwx');
                            }
                            endSubmit();
                        }
                    }).error(function() {
                        endSubmit();
                    });
                }
            });
        }
        
        function logout() {
            $.post('/auth/logout', {
                username: login
            }).done(function (result) {
                refresh();
            });
        }

        $(function() {
            $('#un').focus();
            $(document).keyup(enter);
            $("#img").click(refresh);
            $('#reg').click(submitRegister);
            $('#logout').click(logout);
            refresh();
        });

    </script>
    <style>
        span {
            display: none;
            color: red;
        }
        #reg-form {
            padding: 20px;
            width: 500px;
            border: 3px outset purple;
            background: papayawhip;
        }
        .hide {
            display: none;
        }
    </style>
</head>
<body>
    <h1>Auth System Test</h1>
    <div id="reg-form">
        <input id="un" type="text" placeholder="用户名" tabindex="1">
        <span id="unx">X</span>
        <br/>
        <input id="pw" type="password" placeholder="密码" tabindex="1">
        <span id="pwx">X</span>
        <br/>
        <div id="captcha">
        <a id="img" href="javascript:;" title="点击刷新" style="text-decoration:none">
            <img alt="Captcha" width="80px" height="30px">
        </a>
        <br/>
        <input id="num" type="text" placeholder="验证码" tabindex="1">
        <span id="numx">X</span>
        </div>
        <br/>
        <input id="reg" type="button" value="注册/登陆" tabindex="1">
        <br/>
    </div>
    <div id="content">
        <p>Welcome!</p>
        <br/>
        <p id="name"></p>
        <input id="logout" type="button" value="注销">
    </div>
</body>
</html>